<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tile-based Occlusion Culling | Fyrox - A feature-rich game engine built in Rust</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">
    <meta name="description" content="This article explains the algorithm of tile-based occlusion culling.">
    <meta property="og:title" content="Tile-based Occlusion Culling">
    <meta property="og:description" content="This article explains the algorithm of tile-based occlusion culling.">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://fyrox.rs/blog/post/tile-based-occlusion-culling">
    <meta property="og:image" content="https://fyrox.rs/assets/occlusion/bits.svg">
    <meta name="google-site-verification" content="lgdTRRs1z7wcdVlcyCeUfrdz-U5vikw82_u9L8_Wkgs">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.392114f8.css" as="style"><link rel="preload" href="/assets/js/app.071bf9a3.js" as="script"><link rel="preload" href="/assets/js/7.276fa895.js" as="script"><link rel="preload" href="/assets/js/81.fbc1b922.js" as="script"><link rel="prefetch" href="/assets/js/1.e19270df.js"><link rel="prefetch" href="/assets/js/10.e0d0ffed.js"><link rel="prefetch" href="/assets/js/11.0a9abffc.js"><link rel="prefetch" href="/assets/js/12.5ceca770.js"><link rel="prefetch" href="/assets/js/13.3416a7f4.js"><link rel="prefetch" href="/assets/js/14.defd1520.js"><link rel="prefetch" href="/assets/js/15.16263adb.js"><link rel="prefetch" href="/assets/js/16.cc1a6b3c.js"><link rel="prefetch" href="/assets/js/17.67ec376f.js"><link rel="prefetch" href="/assets/js/18.e8cf7feb.js"><link rel="prefetch" href="/assets/js/2.8c37b931.js"><link rel="prefetch" href="/assets/js/21.ce6cc448.js"><link rel="prefetch" href="/assets/js/22.c7942dfe.js"><link rel="prefetch" href="/assets/js/23.d1bc687e.js"><link rel="prefetch" href="/assets/js/24.0006acee.js"><link rel="prefetch" href="/assets/js/25.89516179.js"><link rel="prefetch" href="/assets/js/26.b5d791e2.js"><link rel="prefetch" href="/assets/js/27.778fc249.js"><link rel="prefetch" href="/assets/js/28.22435935.js"><link rel="prefetch" href="/assets/js/29.b5491630.js"><link rel="prefetch" href="/assets/js/3.901c0e43.js"><link rel="prefetch" href="/assets/js/30.9f1c5f28.js"><link rel="prefetch" href="/assets/js/31.f1f9117e.js"><link rel="prefetch" href="/assets/js/32.d0d6de12.js"><link rel="prefetch" href="/assets/js/33.8bfbff8a.js"><link rel="prefetch" href="/assets/js/34.ec548830.js"><link rel="prefetch" href="/assets/js/35.ddff493c.js"><link rel="prefetch" href="/assets/js/36.ae6e5452.js"><link rel="prefetch" href="/assets/js/37.f4a508ce.js"><link rel="prefetch" href="/assets/js/38.8adaea79.js"><link rel="prefetch" href="/assets/js/39.570be4de.js"><link rel="prefetch" href="/assets/js/4.17353518.js"><link rel="prefetch" href="/assets/js/40.d1fcf9ec.js"><link rel="prefetch" href="/assets/js/41.4672ec2f.js"><link rel="prefetch" href="/assets/js/42.dffb9b79.js"><link rel="prefetch" href="/assets/js/43.7d5db938.js"><link rel="prefetch" href="/assets/js/44.8e5a6634.js"><link rel="prefetch" href="/assets/js/45.750196d0.js"><link rel="prefetch" href="/assets/js/46.b8c29a5e.js"><link rel="prefetch" href="/assets/js/47.5556605b.js"><link rel="prefetch" href="/assets/js/48.23573658.js"><link rel="prefetch" href="/assets/js/49.97e7e266.js"><link rel="prefetch" href="/assets/js/5.a995ec5a.js"><link rel="prefetch" href="/assets/js/50.31d19532.js"><link rel="prefetch" href="/assets/js/51.36692990.js"><link rel="prefetch" href="/assets/js/52.af744869.js"><link rel="prefetch" href="/assets/js/53.90104541.js"><link rel="prefetch" href="/assets/js/54.6035cdac.js"><link rel="prefetch" href="/assets/js/55.46d09d29.js"><link rel="prefetch" href="/assets/js/56.8078cd45.js"><link rel="prefetch" href="/assets/js/57.a25fbcf5.js"><link rel="prefetch" href="/assets/js/58.0f43b62c.js"><link rel="prefetch" href="/assets/js/59.716e2e75.js"><link rel="prefetch" href="/assets/js/6.12df594d.js"><link rel="prefetch" href="/assets/js/60.4daf935e.js"><link rel="prefetch" href="/assets/js/61.3ce7e5d1.js"><link rel="prefetch" href="/assets/js/62.2a4dbd8d.js"><link rel="prefetch" href="/assets/js/63.78aab177.js"><link rel="prefetch" href="/assets/js/64.23695e49.js"><link rel="prefetch" href="/assets/js/65.a5f80dee.js"><link rel="prefetch" href="/assets/js/66.33173353.js"><link rel="prefetch" href="/assets/js/67.1845b67e.js"><link rel="prefetch" href="/assets/js/68.9651f4c2.js"><link rel="prefetch" href="/assets/js/69.2cedcf2b.js"><link rel="prefetch" href="/assets/js/70.55fb25df.js"><link rel="prefetch" href="/assets/js/71.5008eab4.js"><link rel="prefetch" href="/assets/js/72.de115771.js"><link rel="prefetch" href="/assets/js/73.be664ce7.js"><link rel="prefetch" href="/assets/js/74.8d1d1072.js"><link rel="prefetch" href="/assets/js/75.e8729727.js"><link rel="prefetch" href="/assets/js/76.3d39fc87.js"><link rel="prefetch" href="/assets/js/77.7d325b71.js"><link rel="prefetch" href="/assets/js/78.cbc41ee7.js"><link rel="prefetch" href="/assets/js/79.58653b5b.js"><link rel="prefetch" href="/assets/js/8.33024b09.js"><link rel="prefetch" href="/assets/js/80.9ecacfb4.js"><link rel="prefetch" href="/assets/js/82.d1d00301.js"><link rel="prefetch" href="/assets/js/83.1aa191b4.js"><link rel="prefetch" href="/assets/js/84.92e71877.js"><link rel="prefetch" href="/assets/js/85.9faca583.js"><link rel="prefetch" href="/assets/js/86.f34a1850.js"><link rel="prefetch" href="/assets/js/87.5bce458b.js"><link rel="prefetch" href="/assets/js/88.1e211db6.js"><link rel="prefetch" href="/assets/js/89.bdc89d0c.js"><link rel="prefetch" href="/assets/js/9.30f49cc7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.c576337f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.392114f8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--dark"><div class="v-application--wrap"><!----> <main class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div class="container pb-16 blog-post"><h1 class="text-center mt-16 mb-10">Tile-based Occlusion Culling</h1> <div class="content__default"><p>Occlusion culling is a visibility test, that determines if an object is visible or not. There are many different
techniques for occlusion culling with their own pros and cons, and this article introduces another approach for
occlusion culling. It is fast, efficient, and does not require compute shaders and could work on quite old hardware
(including mobile devices).</p> <h2 id="short-explanation"><a href="#short-explanation" class="header-anchor">#</a> Short Explanation</h2> <p>TL;DR. The main idea is to split the screen into multiple tiles, find which object belongs to which tile, render bounding
boxes into a frame buffer with depth buffer from previous frame, find bit index for every pixel in tile for every
bounding box and merge them all using additive blending. Downscale this &quot;visibility buffer&quot; and read it back on CPU and
cache the visibility info for the next frame.</p> <h2 id="algorithm-overview"><a href="#algorithm-overview" class="header-anchor">#</a> Algorithm Overview</h2> <p>Occlusion queries are well known occlusion culling mechanism, yet it has significant downsides that limits its usage:</p> <ol><li>Quite significant lag and visibility info could be obtained with <em>at least</em> one frame delay.</li> <li>Cannot be used with instancing, thus requires separate draw call for each visibility test.</li></ol> <p>The latter is the major downside of occlusions queries, that could easily kill performance instead of improving it.
The tile-based occlusion query algorithm was designed specifically to bypass the lack of instancing and to reduce the lag
to guaranteed one frame.</p> <p>The major steps of the algorithm includes:</p> <ol><li>Perform the initial frustum culling to find objects on screen, that needs to be rendered.</li> <li>Create a frame buffer with depth buffer from the previous frame and one <code>RGBA8</code> color target.</li> <li>Divide the screen using a set tiles of fixed size (for example, 16x16 pixels). Sort the objects list from back-to-front
and project bounding box (AABB) of each object onto the screen and write its index into the tiles it intersects.</li> <li>Take the first 32 (more on that later) object indices from the list of each tile and upload them into special <code>R32UI</code>
texture buffer of <code>((1 + 32) * wTileCount, hTileCount)</code> in size. First element of each tile should contain the amount of objects
in it.</li> <li>Collect all the world-space matrices of each AABB into a buffer (could be a <code>RGBA32F</code> texture or, a vertex buffer, etc.
depends on the target hardware).</li> <li>Enable additive blending and render AABBs of every object using instanced rendering in the frame buffer.</li> <li>In the fragment shader, find corresponding position (1 of 32) of the instance in respective tile buffer and raise one of
32 available bits in pixel. Since we have additive blending enabled, this bit will be combined with all other bits from
other objects in the tile.</li> <li>Create separate frame buffer with one color attachment of <code>R32UI</code> format of <code>(wTileCount, hTileCount)</code> in size and merge
all the bits from each pixel of corresponding tile into one pixel.</li> <li>Read this optimized visibility buffer back on CPU and using the tiles, map each bit to object index and cache this
visibility info for the next frame.</li></ol> <p>The next sections will explain each major step in details.</p> <h2 id="frustum-culling-and-sorting"><a href="#frustum-culling-and-sorting" class="header-anchor">#</a> Frustum Culling and Sorting</h2> <p>Frustum culling must be applied to the set of objects, to prevent GPU from doing unnecessary work and to prevent potential
issues when projecting AABBs of object on screen. Sort the list of visible objects from closest to farthest.</p> <h2 id="frame-buffers"><a href="#frame-buffers" class="header-anchor">#</a> Frame Buffers</h2> <p>There are two frame buffers used in this algorithm:</p> <ol><li>Visibility buffer - full screen RGBA8 texture as a color attachment + depth/stencil texture with D24S8 format. The depth
buffer must be filled with the depth from previous frame.</li> <li>Optimization buffer - <code>(wTileCount, hTileCount)</code> R32UI texture as a color attachment + no depth buffer.</li></ol> <h2 id="tiles-preparation"><a href="#tiles-preparation" class="header-anchor">#</a> Tiles Preparation</h2> <p>When all the frame buffers are prepared, we can prepare the tiles. All we need to do is to uniformly fill the screen with tiles and
find a set of objects in each tile. It is very important to have the list of objects to be sorted back-to-front, this way the
tiles will be filled with object indices from closest to farthest. Since we'll be using axis-aligned bounding boxes for the
visibility determination, all we need to do is to project the AABB of each object on screen plane and find the range of tiles
that intersects with the projected bounds. To project an AABB on screen all we need to do is to project all 8 corners of it on
the screen plane and find min and max points on the screen. This could be done like so:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">screen_space_rect</span><span class="token punctuation">(</span>
    aabb<span class="token punctuation">:</span> <span class="token class-name">AxisAlignedBoundingBox</span><span class="token punctuation">,</span>
    view_projection<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Matrix4</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    viewport<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Rect</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Rect</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> min <span class="token operator">=</span> <span class="token class-name">Vector2</span><span class="token punctuation">::</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token keyword">f32</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> max <span class="token operator">=</span> <span class="token class-name">Vector2</span><span class="token punctuation">::</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token keyword">f32</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> corner <span class="token keyword">in</span> aabb<span class="token punctuation">.</span><span class="token function">corners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> clip_space <span class="token operator">=</span> view_projection <span class="token operator">*</span> <span class="token class-name">Vector4</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>corner<span class="token punctuation">.</span>x<span class="token punctuation">,</span> corner<span class="token punctuation">.</span>y<span class="token punctuation">,</span> corner<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ndc_space <span class="token operator">=</span> clip_space<span class="token punctuation">.</span><span class="token function">xyz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> clip_space<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> normalized_screen_space <span class="token operator">=</span>
            <span class="token class-name">Vector2</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ndc_space<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> ndc_space<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        normalized_screen_space<span class="token punctuation">.</span>x <span class="token operator">=</span> normalized_screen_space<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        normalized_screen_space<span class="token punctuation">.</span>y <span class="token operator">=</span> normalized_screen_space<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> screen_space_corner <span class="token operator">=</span> <span class="token class-name">Vector2</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>normalized_screen_space<span class="token punctuation">.</span>x <span class="token operator">*</span> viewport<span class="token punctuation">.</span>size<span class="token punctuation">.</span>x <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token operator">+</span> viewport<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>normalized_screen_space<span class="token punctuation">.</span>y <span class="token operator">*</span> viewport<span class="token punctuation">.</span>size<span class="token punctuation">.</span>y <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token operator">+</span> viewport<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> screen_space_corner<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> min<span class="token punctuation">.</span>x <span class="token punctuation">{</span>
            min<span class="token punctuation">.</span>x <span class="token operator">=</span> screen_space_corner<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> screen_space_corner<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> min<span class="token punctuation">.</span>y <span class="token punctuation">{</span>
            min<span class="token punctuation">.</span>y <span class="token operator">=</span> screen_space_corner<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> screen_space_corner<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> max<span class="token punctuation">.</span>x <span class="token punctuation">{</span>
            max<span class="token punctuation">.</span>x <span class="token operator">=</span> screen_space_corner<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> screen_space_corner<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> max<span class="token punctuation">.</span>y <span class="token punctuation">{</span>
            max<span class="token punctuation">.</span>y <span class="token operator">=</span> screen_space_corner<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> width <span class="token operator">=</span> max<span class="token punctuation">.</span>x <span class="token operator">-</span> min<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">let</span> height <span class="token operator">=</span> max<span class="token punctuation">.</span>y <span class="token operator">-</span> min<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token class-name">Rect</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>min<span class="token punctuation">.</span>x<span class="token punctuation">,</span> min<span class="token punctuation">.</span>y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>At first we transforming an AABB corner into clip space, then doing perspective divide using absolute value fourth component of
the projected vector. Absolute value here is very important - when the point is behind near clipping plane we still need to know
its projected position and if we'd use signed value, the projection would flip and the screen space rect would be incorrect.
It is also important to clamp the coordinates of the points in viewport bounds, because we'll use them to calculate indices of
the tiles.</p> <p>Now when we know screen space rectangle of AABB, we need to find which tiles are intersecting with the rectangle. We could just
iterate over each tile and check for intersection, but this is too slow and there's much faster solution. All we need to know
position of tiles where min and max point of the rectangle are:</p> <p><img src="/assets/occlusion/interval.svg" alt="interval"></p> <p>This could be calculated by simply dividing the coordinates of each point by the tile size. This way we're essentially transforming
screen space coordinates into tile space. All we need to do is to iterate in <code>min_y..max_y</code> and <code>min_x..max_x</code> ranges and write object
index and its average depth (more about this below) to the respective tiles:</p> <div class="language-rust extra-class"><pre class="language-rust"><code> <span class="token keyword">for</span> <span class="token punctuation">(</span>object_index<span class="token punctuation">,</span> object<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>objects_to_test<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> object_index <span class="token operator">=</span> object_index <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node_ref<span class="token punctuation">)</span> <span class="token operator">=</span> graph<span class="token punctuation">.</span><span class="token function">try_get</span><span class="token punctuation">(</span><span class="token operator">*</span>object<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> aabb <span class="token operator">=</span> node_ref<span class="token punctuation">.</span><span class="token function">world_bounding_box</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> rect <span class="token operator">=</span> <span class="token function">screen_space_rect</span><span class="token punctuation">(</span>aabb<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>view_projection<span class="token punctuation">,</span> viewport<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> debug_renderer<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token namespace">debug_renderer<span class="token punctuation">::</span></span><span class="token function">draw_rect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rect<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> lines<span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">::</span><span class="token constant">WHITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> min <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">screen_space_to_tile_space</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span><span class="token function">left_top_corner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> max <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">screen_space_to_tile_space</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span><span class="token function">right_bottom_corner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> y <span class="token keyword">in</span> min<span class="token punctuation">.</span>y<span class="token punctuation">..=</span>max<span class="token punctuation">.</span>y <span class="token punctuation">{</span>
        <span class="token keyword">let</span> offset <span class="token operator">=</span> y <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>w_tiles<span class="token punctuation">;</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> min<span class="token punctuation">.</span>x<span class="token punctuation">..=</span>max<span class="token punctuation">.</span>x <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>tiles<span class="token punctuation">.</span>tiles<span class="token punctuation">[</span>offset <span class="token operator">+</span> x<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>object_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once the tiles are filled, we need to sort object list of each tile by the average depth and put first 32 objects to plain array:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Default)]</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">GpuTile</span> <span class="token punctuation">{</span>
    objects<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u32</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> gpu_tiles <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">GpuTile</span><span class="token punctuation">::</span>default<span class="token punctuation">;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tiles<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>tile<span class="token punctuation">,</span> gpu_tile<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tiles<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>gpu_tiles<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tile<span class="token punctuation">.</span>objects
        <span class="token punctuation">.</span><span class="token function">sort_by</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>a<span class="token punctuation">,</span> b<span class="token closure-punctuation punctuation">|</span></span> a<span class="token punctuation">.</span>depth<span class="token punctuation">.</span><span class="token function">partial_cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Less</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gpu_tile<span class="token punctuation">.</span>objects <span class="token operator">=</span> tile
        <span class="token punctuation">.</span>objects
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>obj<span class="token closure-punctuation punctuation">|</span></span> obj<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">u32</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">;</span> <span class="token constant">MAX_BITS</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">MAX_BITS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">ArrayVec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token constant">MAX_BITS</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into_inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>All that is left is to upload these <code>gpu_tiles</code> to a rectangular <code>R32UI</code> texture of <code>(32 * wTiles, hTiles)</code> size.</p> <h2 id="rendering"><a href="#rendering" class="header-anchor">#</a> Rendering</h2> <p>Now onto the core of the algorithm - how the visibility is actually determined. At first let's look at this image:</p> <p><img src="/assets/occlusion/bits.svg" alt="interval"></p> <p>The idea is very simple - since each tile could contain only 32 objects, we could give each object its own bit mask
and combine the masks using additive blending when rendering AABBs of objects. We only need to find the appropriate
bit mask in the fragment shader, it could be done like so:</p> <div class="language-c extra-class"><pre class="language-c"><code>uniform <span class="token keyword">int</span> tileSize<span class="token punctuation">;</span>
uniform usampler2D tileBuffer<span class="token punctuation">;</span>
uniform <span class="token keyword">float</span> frameBufferHeight<span class="token punctuation">;</span>

out vec4 FragColor<span class="token punctuation">;</span>

flat in uint objectIndex<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> tileSize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>frameBufferHeight <span class="token operator">-</span> gl_FragCoord<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> tileSize<span class="token punctuation">;</span>

    <span class="token keyword">int</span> bitIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tileDataIndex <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">33</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token function">texelFetch</span><span class="token punctuation">(</span>tileBuffer<span class="token punctuation">,</span> <span class="token function">ivec2</span><span class="token punctuation">(</span>tileDataIndex<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> objectsListStartIndex <span class="token operator">=</span> tileDataIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uint pixelObjectIndex <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">texelFetch</span><span class="token punctuation">(</span>tileBuffer<span class="token punctuation">,</span> <span class="token function">ivec2</span><span class="token punctuation">(</span>objectsListStartIndex <span class="token operator">+</span> i<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pixelObjectIndex <span class="token operator">==</span> objectIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bitIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bitIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        uint outMask <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> bitIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> r <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>outMask <span class="token operator">&amp;</span> <span class="token number">255u</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> g <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token punctuation">(</span>outMask <span class="token operator">&amp;</span> <span class="token number">65280u</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token punctuation">(</span>outMask <span class="token operator">&amp;</span> <span class="token number">16711680u</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token punctuation">(</span>outMask <span class="token operator">&amp;</span> <span class="token number">4278190080u</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
        FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>At first, we're calculating the tile position the current fragment is in. Then fetching the size of the buffer of the tile
and start searching for the current object index in the buffer. The index of the object in the list will be the index of
the corresponding bit. If the object index is found, we packing the mask in RGBA8 pixel using a bunch of bitwise operations.</p> <h2 id="optimization"><a href="#optimization" class="header-anchor">#</a> Optimization</h2> <p>Once the visibility buffer is rendered, we can optimize it before sending the data back to CPU side. Remember, that we have
the buffer size equal to the size of the screen and since modern resolutions are quite high (4k+ in some cases) the amount
of data that needs to be transferred and processed on CPU is huge. What the optimization means? The visibility buffer contains
visibility info of 32 objects per pixel - each bit of 32-bit integer could be either 0 (invisible) or 1 (visible). We also
know that our tile have fixed size and it also can contain only 32 objects. Why not just collapse a bunch of pixels in each
tile into a single pixel? All we need to do is to apply <code>OR</code> logical operation for every pixel in a tile and essentially
combine all of them into a single 32 bit unsigned integer. It could be done like so:</p> <div class="language-c extra-class"><pre class="language-c"><code>uniform <span class="token keyword">int</span> tileSize<span class="token punctuation">;</span>
uniform sampler2D visibilityBuffer<span class="token punctuation">;</span>

out uint optimizedVisibilityMask<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> tileX <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tileY <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> beginX <span class="token operator">=</span> tileX <span class="token operator">*</span> tileSize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> beginY <span class="token operator">=</span> tileY <span class="token operator">*</span> tileSize<span class="token punctuation">;</span>

    <span class="token keyword">int</span> endX <span class="token operator">=</span> <span class="token punctuation">(</span>tileX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> tileSize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> endY <span class="token operator">=</span> <span class="token punctuation">(</span>tileY <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> tileSize<span class="token punctuation">;</span>

    <span class="token keyword">int</span> visibilityMask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> beginY<span class="token punctuation">;</span> y <span class="token operator">&lt;</span> endY<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> beginX<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> endX<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ivec4 mask <span class="token operator">=</span> <span class="token function">ivec4</span><span class="token punctuation">(</span><span class="token function">texelFetch</span><span class="token punctuation">(</span>visibilityBuffer<span class="token punctuation">,</span> <span class="token function">ivec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            visibilityMask <span class="token operator">|=</span> <span class="token punctuation">(</span>mask<span class="token punctuation">.</span>a <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mask<span class="token punctuation">.</span>b <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mask<span class="token punctuation">.</span>g <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> mask<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    optimizedVisibilityMask <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span>visibilityMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>optimizedVisibilityMask</code> must be a <code>R32UI</code> texture and the <code>visibilityBuffer</code> is the full screen texture that was produced
by the previous step.</p> <h2 id="read-the-results-and-cache"><a href="#read-the-results-and-cache" class="header-anchor">#</a> Read the Results and Cache</h2> <p>The optimized visibility buffer can be transferred back to RAM using standard reading mechanism of your GAPI. All we need to do
is to use that buffer to prepare the visibility cache.</p> <p>Keep in mind, that we're always 1 frame behind and thus we must cache the results of visibility test somewhere, so it can be
used in the next frame. A good option is to use a hash map, but what if there's no visibility info for an object? In this
case it must be considered visible. It is needed because if an observer moves or rotates, some objects will inevitably get on
the screen and we must renderer them. Usually this is not an issue, because two adjacent frames keeps some level of coherency
and in vast majority of cases it is more than 90%.</p> <h2 id="limitations-and-possible-improvements"><a href="#limitations-and-possible-improvements" class="header-anchor">#</a> Limitations and Possible Improvements</h2> <p>The described occlusion culling algorithm has some issues, but all of them aren't critical and could be solved:</p> <ol><li>In some cases 32 objects per pixel is not enough - this could lead to popping effects in distant objects when multiple
objects occupy the same tiles. This issue could be fixed in two major ways: either consider all the objects outside of the range
as visible, or add more precision. The first option could lead to redundant draw calls and thus may decrease performance.
The second option could be implemented in a few ways: either change pixel format to <code>RGBA16</code> and this will effectively double
the maximum amount of objects or add &quot;depth peeling&quot; and create 1 or more additional layers. These two approaches could
be combined. There's no best approach - adding more layers or increasing precision will lead to higher memory usage and also
could lead to memory bandwidth pressure, which is an issue on low-end PCs and always an issue on mobile platforms. As a last
potential fix to this issue is to simply change the tile size, but keep in mind that it has its own downsides - too small tile
will lead to increased load of the CPU and too large will lead to even worse popping.</li> <li>VRAM -&gt; RAM data transfer - this always has some performance penalty, but it must be measured. If it overweighs the speedup
of occlusion culling, then you could use the visibility buffer directly on GPU, but it could be done on modern hardware only.</li></ol></div></div></div></main> <footer class="v-footer v-sheet theme--dark v-footer--padless"><div class="darken-4 white--text text-center v-card v-card--flat v-sheet theme--dark rounded-0" style="width:100%;"><hr role="separator" aria-orientation="horizontal" class="v-divider theme--dark"> <div class="v-card__text"><div data-v-7ab6dcee><a href="https://discord.com/invite/xENF5Uh" class="white--text v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-7ab6dcee><span class="v-btn__content"><span class="d-flex mr-1" data-v-7ab6dcee><img src="/assets/custom_icons/discord.svg" class="custom-icon" data-v-7ab6dcee></span> <!----></span></a><a href="https://github.com/FyroxEngine/Fyrox" class="white--text v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-7ab6dcee><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mr-1 mdi mdi-github theme--dark" style="font-size:24px;" data-v-7ab6dcee></i> <!----></span></a><a href="https://twitter.com/DmitryNStepanov" class="white--text v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-7ab6dcee><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mr-1 mdi mdi-twitter theme--dark" style="font-size:24px;" data-v-7ab6dcee></i> <!----></span></a><a href="/sponsor.html" class="white--text v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-7ab6dcee><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mr-1 mdi mdi-patreon theme--dark" style="font-size:24px;" data-v-7ab6dcee></i> <!----></span></a></div></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--dark"> <div class="v-card__text white--text">
            Fyrox Engine 2019 - 2025
        </div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.071bf9a3.js" defer></script><script src="/assets/js/7.276fa895.js" defer></script><script src="/assets/js/81.fbc1b922.js" defer></script>
  </body>
</html>
